<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信邦樣單助手 - 專業數據提取系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .tab-separated { white-space: pre; }
        /* 滾動條美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 自定義圖示組件 (解決外部庫報錯問題)
        const Icon = ({ name, size = 24, className = "" }) => {
            const paths = {
                Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></g>,
                FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></g>,
                Copy: <g><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></g>,
                Check: <polyline points="20 6 9 17 4 12" />,
                Loader2: <g><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></g>,
                FileUp: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="M15 15l-3-3-3 3"/></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></g>,
                Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
                X: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                Trash2: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></g>,
                Files: <g><path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V6.5L15.5 2z"/><path d="M3 7.6v12.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h9.8"/><path d="M15 2v5h5"/></g>,
                ListFilter: <g><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></g>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {paths[name]}
                </svg>
            );
        };

        function App() {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentProcessingIndex, setCurrentProcessingIndex] = useState(-1);
            
            // 分類結果儲存
            const [applyPnResults, setApplyPnResults] = useState([]);
            const [feasibilityResults, setFeasibilityResults] = useState([]);
            const [quotationResults, setQuotationResults] = useState([]);
            const [sampleResults, setSampleResults] = useState([]);
            
            const [copiedType, setCopiedType] = useState('');
            const [error, setError] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('SINBON_API_KEY') || "");

            const handleFileChange = (e) => {
                const selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length > 0) {
                    setFiles(prev => [...prev, ...selectedFiles]);
                    setError('');
                }
            };

            const removeFile = (index) => setFiles(files.filter((_, i) => i !== index));
            
            const clearAll = () => {
                setFiles([]);
                setApplyPnResults([]);
                setFeasibilityResults([]);
                setQuotationResults([]);
                setSampleResults([]);
                setError('');
            };

            const saveApiKey = (key) => {
                setApiKey(key);
                if (key) localStorage.setItem('SINBON_API_KEY', key);
                else localStorage.removeItem('SINBON_API_KEY');
                setShowSettings(false);
            };

            const readFileAsBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const processBatch = async () => {
                if (files.length === 0) {
                    setError('請先選擇至少一個檔案。');
                    return;
                }
                setLoading(true);
                setError('');
                setApplyPnResults([]);
                setFeasibilityResults([]);
                setQuotationResults([]);
                setSampleResults([]);

                const prompt = `你是一個專業的文件解析專家。這是一份「信邦 (Sinbon) 樣品需求單」。
請辨認該單據是「3-1 只需申請信邦料號」、「3-2 可行性評估報告」、「3-3 報價部分」還是「3-4 送樣承認部分」勾選。

模式 1：若為「3-1 只需申請信邦料號」，行首加 [APPLY_PN]，輸出 9 個欄位。
模式 2：若為「3-2 可行性評估報告」，行首加 [FEASIBILITY]，輸出 9 個欄位。
模式 3：若為「3-3 報價部分」(Quotation)，行首加 [QUOTE]，輸出以下 10 個欄位：
客戶料號 (含版本)\t需求日期\t申請單號\t信邦料號 (含版本)\tEAU\tLife Cycle\tRFQ. NO.\t負責業務\t客戶名稱\t備註

模式 4：若為「3-4 送樣承認部分」(Sample)，行首加 [SAMPLE]，輸出以下 9 個欄位：
客戶料號 (含版本)\t需求日期\t申請單號\t信邦料號 (含版本)\t數量\tRFQ. NO.\t負責業務\t客戶名稱\t備註

針對 3-1, 3-2, 3-4 的 9 欄位規則：
客戶料號 (含版本)\t需求日期\t申請單號\t信邦料號 (含版本)\t數量\tRFQ. NO.\t負責業務\t客戶名稱\t備註

嚴格資料規格：
1. EAU 與 數量：只輸出「數字」，不得包含單位文字。
2. 需求日期：格式必須嚴格轉換為 --YYYY-MM-DD--。
【最重要規則：日期格式】
需求日期絕對必須轉換為 --YYYY-MM-DD-- (前後必須各有兩條橫線)。
錯誤範例：2026-01-21 (X), --2026/01/21-- (X)
正確範例：--2026-01-21-- (O)
3. 負責業務：只提取姓名，刪除括號及工號。
4. 輸出要求：只輸出提取結果，欄位間以 Tab 隔開。`;

                try {
                    for (let i = 0; i < files.length; i++) {
                        setCurrentProcessingIndex(i);
                        const file = files[i];
                        const base64Data = await readFileAsBase64(file);
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        { inlineData: { mimeType: file.type, data: base64Data } }
                                    ]
                                }]
                            })
                        });

                        if (!response.ok) {
                            throw new Error('API 辨識失敗。請確認 API Key 是否設定正確。');
                        }

                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                        
                        if (text.includes('[APPLY_PN]')) {
                            setApplyPnResults(prev => [...prev, text.replace('[APPLY_PN]', '').trim()]);
                        } else if (text.includes('[FEASIBILITY]')) {
                            setFeasibilityResults(prev => [...prev, text.replace('[FEASIBILITY]', '').trim()]);
                        } else if (text.includes('[QUOTE]')) {
                            setQuotationResults(prev => [...prev, text.replace('[QUOTE]', '').trim()]);
                        } else if (text.includes('[SAMPLE]')) {
                            setSampleResults(prev => [...prev, text.replace('[SAMPLE]', '').trim()]);
                        }
                        
                        if (files.length > 1) await new Promise(r => setTimeout(r, 600));
                    }
                } catch (err) {
                    setError(err.message || '辨識過程中發生連線問題。');
                } finally {
                    setLoading(false);
                    setCurrentProcessingIndex(-1);
                }
            };

            const copyToClipboard = (type, data) => {
                const content = data.join('\n');
                const el = document.createElement('textarea');
                el.value = content;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    setCopiedType(type);
                    setTimeout(() => setCopiedType(''), 2000);
                } catch (err) {
                    console.error('複製失敗');
                }
                document.body.removeChild(el);
            };

            const ResultSection = ({ title, type, data, color, iconColor }) => {
                if (data.length === 0 && !loading) return null;
                return (
                    <div className="space-y-5 animate-in fade-in slide-in-from-bottom-6">
                        <div className="flex justify-between items-center px-4">
                            <div className="flex items-center gap-3">
                                <div className={`w-4 h-4 ${color} rounded-full shadow-lg`}></div>
                                <h3 className="text-2xl font-black text-slate-800 tracking-tight uppercase">{title}</h3>
                                <span className={`text-sm ${iconColor} px-4 py-1 rounded-full font-black border opacity-75`}>{data.length} 筆</span>
                            </div>
                            <button 
                                disabled={data.length === 0} 
                                onClick={() => copyToClipboard(type, data)} 
                                className={`px-10 py-3.5 rounded-2xl font-black transition-all shadow-xl ${copiedType === type ? 'bg-green-500 text-white' : 'bg-slate-900 text-white hover:bg-slate-700 disabled:opacity-30'}`}
                            >
                                {copiedType === type ? <><Icon name="Check" size={24} />已複製</> : <><Icon name="Copy" size={24} />複製此區</>}
                            </button>
                        </div>
                        <div className={`w-full p-10 bg-slate-900 rounded-[3rem] font-mono text-base overflow-x-auto border-8 border-slate-800 shadow-2xl leading-relaxed whitespace-pre min-h-[140px] ${type === 'quote' ? 'text-amber-400' : type === 'sample' ? 'text-blue-400' : 'text-emerald-400'}`}>
                            {data.join('\n') || (loading && "處理中...")}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-[#F8FAFC] flex flex-col items-center p-4 sm:p-10">
                    <div className="w-full max-w-5xl bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden relative">
                        
                        {/* 設定彈窗 */}
                        {showSettings && (
                            <div className="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6">
                                <div className="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl border border-slate-100 animate-in zoom-in-95 duration-200">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                            <Icon name="Settings" className="text-blue-600" /> API 設定
                                        </h2>
                                        <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full">
                                            <Icon name="X" size={24} />
                                        </button>
                                    </div>
                                    <input 
                                        type="password" 
                                        placeholder="貼上您的 Gemini API Key..." 
                                        value={apiKey} 
                                        onChange={(e) => setApiKey(e.target.value)} 
                                        className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl mb-6 font-mono text-sm outline-none focus:border-blue-500 transition-all" 
                                    />
                                    <div className="flex flex-col gap-3">
                                        <button onClick={() => saveApiKey(apiKey)} className="w-full py-4 bg-[#0047AB] text-white rounded-2xl font-bold hover:bg-blue-800 transition-all shadow-lg">
                                            儲存金鑰
                                        </button>
                                        <button onClick={() => { setApiKey(""); setShowSettings(false); }} className="w-full py-3 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 flex items-center justify-center gap-2">
                                            <Icon name="Zap" size={18} className="text-amber-500" /> 略過 (使用系統預設)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Header */}
                        <div className="bg-[#0047AB] p-10 text-white relative">
                            <button onClick={() => setShowSettings(true)} className="absolute top-8 right-8 p-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all">
                                <Icon name="Settings" size={28} />
                            </button>
                            <div className="flex items-center space-x-6">
                                <div className="bg-white/10 p-5 rounded-[2rem] backdrop-blur-md border border-white/20 shadow-inner">
                                    <Icon name="ListFilter" size={48} />
                                </div>
                                <div>
                                    <h1 className="text-4xl font-black tracking-tight uppercase">Sinbon Categorizer</h1>
                                    <p className="text-blue-200 mt-2 font-medium italic">批次樣單提取系統 • 自動分類 3-1 ~ 3-4</p>
                                </div>
                            </div>
                        </div>

                        <div className="p-8 md:p-12 space-y-12">
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-2">
                                    <h3 className="text-xl font-bold text-slate-800">1. 選取樣單 (多選 PDF / 圖片)</h3>
                                    {files.length > 0 && <button onClick={clearAll} className="text-xs text-red-500 font-bold hover:underline">全部清除</button>}
                                </div>
                                <div className="relative group border-4 border-dashed rounded-[3rem] p-16 text-center bg-slate-50 border-slate-300 hover:border-blue-400 transition-all">
                                    <input type="file" multiple onChange={handleFileChange} accept=".pdf,image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    <Icon name="Upload" className="mx-auto text-blue-600 mb-6" size={48} />
                                    <p className="text-2xl font-black text-slate-700">點擊或拖放檔案</p>
                                    <p className="text-slate-400 mt-2 font-medium">目前選取 {files.length} 個檔案</p>
                                </div>
                                {files.length > 0 && (
                                    <div className="max-h-52 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-5 bg-slate-50 rounded-[2rem] border">
                                        {files.map((f, i) => (
                                            <div key={i} className={`flex items-center justify-between p-3 rounded-xl border ${i === currentProcessingIndex ? 'bg-blue-600 text-white' : 'bg-white'}`}>
                                                <div className="flex items-center space-x-3 truncate"><Icon name="FileText" size={18} /><span className="truncate text-sm font-bold">{f.name}</span></div>
                                                {i !== currentProcessingIndex && <button onClick={() => removeFile(i)} className="text-slate-300 hover:text-red-500"><Icon name="X" size={18} /></button>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <button onClick={processBatch} disabled={files.length === 0 || loading} className={`w-full py-8 rounded-[2.5rem] font-black text-2xl transition-all shadow-2xl flex flex-col items-center justify-center ${files.length === 0 || loading ? 'bg-slate-100 text-slate-300' : 'bg-[#0047AB] text-white hover:bg-blue-800'}`}>
                                {loading ? (
                                    <div className="flex flex-col items-center">
                                        <div className="flex items-center gap-4"><Icon name="Loader2" className="animate-spin" size={36} /><span>解析中 ({currentProcessingIndex + 1}/{files.length})</span></div>
                                        <div className="w-64 bg-white/20 h-2 mt-5 rounded-full overflow-hidden">
                                            <div className="bg-white h-full transition-all duration-500" style={{ width: `${((currentProcessingIndex + 1) / files.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                ) : <span className="flex items-center gap-3"><Icon name="Zap" /> 開始批次辨識</span>}
                            </button>

                            {error && <div className="p-7 bg-red-50 border-2 border-red-100 text-red-600 rounded-[2rem] flex items-center gap-5 font-bold animate-pulse"><Icon name="AlertCircle" size={32} />{error}</div>}

                            <div className="space-y-12">
                                <ResultSection title="3-1 申請信邦料號" type="apply_pn" data={applyPnResults} color="bg-emerald-500" iconColor="bg-emerald-100 text-emerald-700" />
                                <ResultSection title="3-2 可行性評估" type="feasibility" data={feasibilityResults} color="bg-cyan-500" iconColor="bg-cyan-100 text-cyan-700" />
                                <ResultSection title="3-3 報價需求 (Quotation)" type="quote" data={quotationResults} color="bg-amber-500" iconColor="bg-amber-100 text-amber-700" />
                                <ResultSection title="3-4 送樣承認 (Sample)" type="sample" data={sampleResults} color="bg-blue-500" iconColor="bg-blue-100 text-blue-700" />
                            </div>
                        </div>
                        <div className="bg-slate-50 p-12 border-t text-center text-[11px] text-slate-400 font-black uppercase tracking-[0.3em]">SINBON Extractor System v2.3 • Support 3-1 ~ 3-4</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
