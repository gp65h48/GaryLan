import React, { useState, useEffect } from 'react';
import { Upload, FileText, Copy, Check, Loader2, FileUp, AlertCircle, Settings, X, Trash2, Files, Info, ListFilter, Zap } from 'lucide-react';

const App = () => {
  const [files, setFiles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [currentProcessingIndex, setCurrentProcessingIndex] = useState(-1);
  
  // 分類儲存結果
  const [quotationResults, setQuotationResults] = useState([]);
  const [sampleResults, setSampleResults] = useState([]);
  
  const [copiedType, setCopiedType] = useState(''); // 'quote' or 'sample'
  const [error, setError] = useState('');
  const [showSettings, setShowSettings] = useState(false);
  
  // API Key 狀態管理
  const [apiKey, setApiKey] = useState(localStorage.getItem('SINBON_API_KEY') || "");

  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    if (selectedFiles.length > 0) {
      setFiles(prev => [...prev, ...selectedFiles]);
      setError('');
    }
  };

  const removeFile = (index) => {
    setFiles(files.filter((_, i) => i !== index));
  };

  const clearAll = () => {
    setFiles([]);
    setQuotationResults([]);
    setSampleResults([]);
    setError('');
  };

  const saveApiKey = (key) => {
    setApiKey(key);
    if (key) {
      localStorage.setItem('SINBON_API_KEY', key);
    } else {
      localStorage.removeItem('SINBON_API_KEY');
    }
    setShowSettings(false);
  };

  const skipApiKey = () => {
    setApiKey(""); 
    setShowSettings(false);
  };

  const readFileAsBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };

  const processBatch = async () => {
    if (files.length === 0) {
      setError('請先選擇至少一個檔案');
      return;
    }

    setLoading(true);
    setError('');
    setQuotationResults([]);
    setSampleResults([]);
    
    // 更新後的 Prompt，包含純數字要求與姓名過濾
    const prompt = `你是一個專業的文件解析專家。這是一份「信邦 (Sinbon) 樣品需求單」。
    請先辨認該單據是「3-3 報價部分」還是「3-4 送樣承認部分」勾選。

    模式 A：若勾選「3-3 報價部分」(Quotation)，請輸出以下 10 個欄位，並在行首加上 [QUOTE]：
    [QUOTE] 客戶料號 (含版本)\t需求日期\t申請單號\t信邦料號 (含版本)\tEAU\tLife Cycle\tRFQ. NO.\t負責業務\t客戶名稱\t備註

    模式 B：若勾選「3-4 送樣承認部分」(Sample)，請輸出以下 9 個欄位，並在行首加上 [SAMPLE]：
    [SAMPLE] 客戶料號 (含版本)\t需求日期\t申請單號\t信邦料號 (含版本)\t數量\tRFQ. NO.\t負責業務\t客戶名稱\t備註

    針對欄位內容的嚴格要求：
    1. EAU 與 數量：請只輸出「數字」，必須刪除所有單位文字（例如：150 pcs 應輸出 150，1 份 應輸出 1）。
    2. 需求日期：必須嚴格轉換為格式 --YYYY-MM-DD-- (例如 --2026-02-26--)。
    3. 負責業務：請提取申請人姓名，並「刪除」括號及其內容（例如：Irina Chang (DBA600) 應輸出 Irina Chang，Johnny Wu (DBA600) 應輸出 Johnny Wu）。
    4. 輸出要求：只輸出提取結果，欄位間以 Tab 隔開，不含標題。`;

    try {
      for (let i = 0; i < files.length; i++) {
        setCurrentProcessingIndex(i);
        const file = files[i];
        const base64Data = await readFileAsBase64(file);
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inlineData: { mimeType: file.type, data: base64Data } }
              ]
            }]
          })
        });

        if (!response.ok) {
          if (response.status === 403 || response.status === 400) {
            throw new Error('API 金鑰錯誤。請點擊右上角設定輸入金鑰或選取略過。');
          }
          throw new Error(`處理失敗 (狀態碼: ${response.status})`);
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        
        if (text.includes('[QUOTE]')) {
          setQuotationResults(prev => [...prev, text.replace('[QUOTE]', '').trim()]);
        } else if (text.includes('[SAMPLE]')) {
          setSampleResults(prev => [...prev, text.replace('[SAMPLE]', '').trim()]);
        }
        
        if (files.length > 1) await new Promise(r => setTimeout(r, 600));
      }
    } catch (err) {
      setError(err.message || '連線失敗');
    } finally {
      setLoading(false);
      setCurrentProcessingIndex(-1);
    }
  };

  const copyResults = (type) => {
    const content = type === 'quote' ? quotationResults.join('\n') : sampleResults.join('\n');
    const textArea = document.createElement("textarea");
    textArea.value = content;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setCopiedType(type);
      setTimeout(() => setCopiedType(''), 2000);
    } catch (err) {
      console.error('複製失敗');
    }
    document.body.removeChild(textArea);
  };

  return (
    <div className="min-h-screen bg-[#F8FAFC] flex flex-col items-center p-4 sm:p-8 font-sans">
      <div className="w-full max-w-5xl bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden relative">
        
        {/* 設定彈窗 */}
        {showSettings && (
          <div className="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-6">
            <div className="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl border border-slate-100">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                  <Settings size={20} className="text-blue-600" /> API 金鑰設定
                </h2>
                <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded-full">
                  <X size={20} />
                </button>
              </div>
              <input 
                type="password"
                placeholder="在此貼上您的 API Key..."
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value)}
                className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-blue-500 outline-none mb-4 font-mono text-sm"
              />
              <div className="flex flex-col gap-3">
                <button onClick={() => saveApiKey(apiKey)} className="w-full py-4 bg-[#0047AB] text-white rounded-2xl font-bold hover:bg-blue-800 transition-all shadow-lg">儲存並使用</button>
                <button onClick={skipApiKey} className="w-full py-3 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 flex items-center justify-center gap-2">
                  <Zap size={16} className="text-amber-500 fill-amber-500" /> 略過 (使用預設系統金鑰)
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Header */}
        <div className="bg-[#0047AB] p-10 text-white relative">
          <button onClick={() => setShowSettings(true)} className="absolute top-8 right-8 p-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all"><Settings size={24} /></button>
          <div className="flex items-center space-x-6">
            <div className="bg-white/10 p-4 rounded-[2rem] backdrop-blur-md border border-white/20 shadow-inner">
              <ListFilter size={40} />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tight uppercase">Sinbon Categorizer</h1>
              <p className="text-blue-200 mt-1 font-medium italic italic">樣單自動分類提取系統 (數據已優化)</p>
            </div>
          </div>
        </div>

        <div className="p-8 md:p-12 space-y-10">
          <div className="space-y-4">
            <div className="flex justify-between items-center px-2">
              <h3 className="text-lg font-bold text-slate-800 flex items-center">
                <span className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black mr-2">1</span>
                選取樣單 (PDF/圖片)
              </h3>
              {files.length > 0 && (
                <button onClick={clearAll} className="text-xs text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded-full transition-colors flex items-center">
                  <Trash2 size={14} className="mr-1" /> 清除
                </button>
              )}
            </div>
            <div className="relative group">
              <input type="file" multiple onChange={handleFileChange} accept=".pdf,image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
              <div className={`border-3 border-dashed rounded-[2.5rem] p-12 text-center transition-all ${files.length > 0 ? 'border-blue-500 bg-blue-50/50' : 'border-slate-300 hover:border-blue-400 bg-slate-50'}`}>
                <Upload className="mx-auto text-slate-300 mb-2" size={48} />
                <p className="text-xl font-bold text-slate-600">拖放檔案或點擊選取</p>
                <p className="text-sm text-slate-400 mt-1">目前已加入 {files.length} 個檔案</p>
              </div>
            </div>
          </div>

          <button
            onClick={processBatch}
            disabled={files.length === 0 || loading}
            className={`w-full py-7 rounded-[2rem] font-black text-2xl transition-all shadow-2xl flex items-center justify-center ${
              files.length === 0 || loading ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'bg-[#0047AB] text-white hover:bg-blue-800 active:scale-95'
            }`}
          >
            {loading ? <div className="flex items-center gap-4"><Loader2 className="animate-spin" size={32} /><span>辨識中 ({currentProcessingIndex + 1} / {files.length})</span></div> : <span>開始批次辨識並分類</span>}
          </button>

          {error && <div className="p-6 bg-red-50 border border-red-100 text-red-600 rounded-[1.5rem] flex items-center gap-4 font-bold"><AlertCircle size={28}/>{error}</div>}

          <div className="space-y-10">
            {/* 報價結果 */}
            {(quotationResults.length > 0 || loading) && (
              <div className="space-y-4">
                <div className="flex justify-between items-center px-4">
                  <div className="flex items-center gap-3">
                    <div className="w-4 h-4 bg-amber-500 rounded-full"></div>
                    <h3 className="text-xl font-black text-slate-800 uppercase">報價需求 (3-3)</h3>
                    <span className="text-xs bg-amber-100 text-amber-700 px-3 py-1 rounded-full font-black">{quotationResults.length}</span>
                  </div>
                  <button disabled={quotationResults.length === 0} onClick={() => copyResults('quote')} className={`flex items-center gap-2 px-8 py-2.5 rounded-2xl font-black transition-all shadow-lg ${copiedType === 'quote' ? 'bg-green-500 text-white' : 'bg-slate-800 text-white hover:bg-slate-700 disabled:opacity-30'}`}>
                    {copiedType === 'quote' ? <><Check size={20}/>已複製</> : <><Copy size={20}/>複製區塊</>}
                  </button>
                </div>
                <div className="w-full p-8 bg-slate-900 text-amber-400 rounded-[2.5rem] font-mono text-sm overflow-x-auto border-4 border-slate-800 shadow-2xl whitespace-pre leading-relaxed min-h-[100px]">
                  {quotationResults.join('\n') || (loading && "處理中...")}
                </div>
              </div>
            )}

            {/* 送樣結果 */}
            {(sampleResults.length > 0 || loading) && (
              <div className="space-y-4">
                <div className="flex justify-between items-center px-4">
                  <div className="flex items-center gap-3">
                    <div className="w-4 h-4 bg-blue-500 rounded-full"></div>
                    <h3 className="text-xl font-black text-slate-800 uppercase">送樣承認 (3-4)</h3>
                    <span className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-black">{sampleResults.length}</span>
                  </div>
                  <button disabled={sampleResults.length === 0} onClick={() => copyResults('sample')} className={`flex items-center gap-2 px-8 py-2.5 rounded-2xl font-black transition-all shadow-lg ${copiedType === 'sample' ? 'bg-green-500 text-white' : 'bg-slate-800 text-white hover:bg-slate-700 disabled:opacity-30'}`}>
                    {copiedType === 'sample' ? <><Check size={20}/>已複製</> : <><Copy size={20}/>複製區塊</>}
                  </button>
                </div>
                <div className="w-full p-8 bg-slate-900 text-blue-400 rounded-[2.5rem] font-mono text-sm overflow-x-auto border-4 border-slate-800 shadow-2xl whitespace-pre leading-relaxed min-h-[100px]">
                  {sampleResults.join('\n') || (loading && "處理中...")}
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="bg-slate-50 p-10 border-t border-slate-100 flex items-center justify-between text-[10px] text-slate-400 font-black uppercase tracking-[0.2em]">
          <span>SINBON Extractor v2.2</span>
          <span>EAU/Qty: Numbers Only • Date: --YYYY-MM-DD-- • Name: Pure Name</span>
        </div>
      </div>
    </div>
  );
};

export default App;
