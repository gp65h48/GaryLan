<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM 樹狀階層差異分析系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', 'PingFang TC', sans-serif; }
        .diff-added { background-color: #f0fdf4; border-left: 4px solid #22c55e; }
        .diff-deleted { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .diff-modified { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        /* 階層引導線樣式 */
        .indent-line {
            border-left: 1px solid #e2e8f0;
            margin-left: 8px;
            padding-left: 12px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">

    <div class="max-w-[1600px] mx-auto p-4 md:p-8">
        <!-- 標題 -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-2xl font-extrabold text-indigo-900">BOM 樹狀階層差異分析系統</h1>
                <p class="text-gray-500 text-sm mt-1 flex items-center gap-2">
                    <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold uppercase">結構優先對比</span>
                    <span>比對 Part, Qty, Mfr 等 10 欄位。子階層將緊跟母階層顯示。</span>
                </p>
            </div>
            <div class="flex gap-3">
                <button id="exportBtn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-xl font-bold transition-all shadow-md flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>匯出 XLSX</span>
                </button>
            </div>
        </header>

        <!-- 檔案上傳 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl border border-gray-200">
                <label class="text-sm font-bold text-gray-600 mb-2 block font-sans">1. 基準 BOM (舊版產品)</label>
                <input type="file" id="file1" accept=".csv, .xlsx, .xls" class="text-sm text-gray-500 w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
            </div>
            <div class="bg-white p-5 rounded-xl border border-gray-200">
                <label class="text-sm font-bold text-gray-600 mb-2 block font-sans">2. 目標 BOM (新版產品)</label>
                <input type="file" id="file2" accept=".csv, .xlsx, .xls" class="text-sm text-gray-500 w-full file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
            </div>
        </div>

        <div class="flex justify-center mb-8">
            <button id="compareBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3 px-16 rounded-xl shadow-lg transition-transform hover:scale-105 active:scale-95">
                執行結構比對
            </button>
        </div>

        <!-- 儀表板 -->
        <div id="dashboard" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                <div class="text-xs font-bold text-gray-400 uppercase">差異總數</div>
                <div id="totalItems" class="text-2xl font-black">0</div>
            </div>
            <div class="bg-green-50 p-4 rounded-xl border border-green-100 text-center">
                <div class="text-xs font-bold text-green-500 uppercase">新增 (Added)</div>
                <div id="countAdded" class="text-2xl font-black text-green-700">0</div>
            </div>
            <div class="bg-red-50 p-4 rounded-xl border border-red-100 text-center">
                <div class="text-xs font-bold text-red-500 uppercase">刪除 (Deleted)</div>
                <div id="countDeleted" class="text-2xl font-black text-red-700">0</div>
            </div>
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-100 text-center">
                <div class="text-xs font-bold text-amber-600 uppercase">變更 (Changed)</div>
                <div id="countModified" class="text-2xl font-black text-amber-700">0</div>
            </div>
        </div>

        <!-- 結果 -->
        <div id="resultContainer" class="hidden bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-gray-500 font-bold uppercase">
                            <th class="px-6 py-4 w-24 text-center">狀態</th>
                            <th class="px-6 py-4">樹狀階層 / 零件 (Level / Part Number)</th>
                            <th class="px-6 py-4 w-20 text-center">Item</th>
                            <th class="px-6 py-4">Parent (輔助顯示)</th>
                            <th class="px-6 py-4">變更詳細清單 (基準 ➔ 目標)</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </div>

        <div id="loader" class="hidden py-20 text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-indigo-600 border-t-transparent"></div>
            <p class="mt-4 text-indigo-900 font-bold">正在構建樹狀關係並分析差異...</p>
        </div>
    </div>

    <script>
        // 指定比對的 10 個核心欄位
        const TARGET_COLS = ['Part', 'Qty', 'ExQty', 'UOM', 'CE', 'Rev', 'Critical', 'Mfr Part No', 'Mfr Name', 'Item Text'];

        let compareResults = [];
        let rootInfo = { oldRoot: null, newRoot: null };

        function parseLevel(str) {
            const s = String(str || "").trim();
            const dotCount = (s.match(/\./g) || []).length;
            const depth = dotCount / 2;
            const val = s.replace(/[\s\.]/g, '');
            return { depth, val: parseInt(val) || 0, raw: s };
        }

        function getPrefix(part) {
            const s = String(part || "").trim();
            const lastDash = s.lastIndexOf('-');
            if (lastDash === -1) return s;
            return s.substring(0, lastDash);
        }

        function normItem(item) {
            const s = String(item || "").trim();
            const n = parseInt(s);
            return isNaN(n) ? s : String(n);
        }

        function normalizeData(data) {
            return data.map(row => {
                const normalized = {};
                Object.keys(row).forEach(k => {
                    const cleanK = k.trim().replace(/\s+/g, ' ');
                    normalized[cleanK] = row[k];
                });
                return normalized;
            });
        }

        function buildTree(data) {
            const root = { children: [], depth: -1 };
            const stack = [root];
            data.forEach(row => {
                const lv = parseLevel(row.Level);
                const node = { ...row, _lv: lv, children: [] };
                while (stack.length > 1 && stack[stack.length - 1]._lv.depth >= lv.depth) {
                    stack.pop();
                }
                stack[stack.length - 1].children.push(node);
                stack.push(node);
            });
            return root.children;
        }

        async function readExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                    resolve(normalizeData(json));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 遞迴比對引擎：深度優先輸出結果
        function compareNodes(list1, list2, results) {
            const matched2 = new Set();
            const matched1 = new Set();

            // 1. 第一輪：精確匹配 (Item + 全料號)
            list2.forEach((n2, idx2) => {
                const n1Idx = list1.findIndex((n1, idx1) => 
                    !matched1.has(idx1) && 
                    normItem(n1.Item) === normItem(n2.Item) && 
                    String(n1.Part).trim() === String(n2.Part).trim()
                );
                if (n1Idx !== -1) {
                    matched2.add(idx2);
                    matched1.add(n1Idx);
                    const n1 = list1[n1Idx];
                    checkChanges(n1, n2, results);
                    compareNodes(n1.children, n2.children, results);
                }
            });

            // 2. 第二輪：模糊匹配 (Item + 料號前綴) -> 判定為「變更」
            list2.forEach((n2, idx2) => {
                if (matched2.has(idx2)) return;
                const n1Idx = list1.findIndex((n1, idx1) => 
                    !matched1.has(idx1) && 
                    normItem(n1.Item) === normItem(n2.Item) && 
                    getPrefix(n1.Part) === getPrefix(n2.Part)
                );
                if (n1Idx !== -1) {
                    matched2.add(idx2);
                    matched1.add(n1Idx);
                    const n1 = list1[n1Idx];
                    checkChanges(n1, n2, results);
                    compareNodes(n1.children, n2.children, results);
                }
            });

            // 3. 第三輪：處理剩下的「新增」
            list2.forEach((n2, idx2) => {
                if (!matched2.has(idx2)) {
                    results.push({ type: '新增', data: n2 });
                    addAllChildren(n2.children, results, '新增');
                }
            });

            // 4. 第四輪：處理剩下的「刪除」
            list1.forEach((n1, idx1) => {
                if (!matched1.has(idx1)) {
                    results.push({ type: '刪除', data: n1 });
                    addAllChildren(n1.children, results, '刪除');
                }
            });
        }

        function checkChanges(n1, n2, results) {
            const diffs = [];
            TARGET_COLS.forEach(col => {
                let v1 = String(n1[col] || "").trim();
                let v2 = String(n2[col] || "").trim();
                if (v1 !== v2) diffs.push({ col, v1, v2 });
            });
            if (diffs.length > 0) {
                results.push({ type: '變更', data: n2, diffs });
            }
        }

        function addAllChildren(children, results, type) {
            children.forEach(child => {
                results.push({ type: type, data: child });
                addAllChildren(child.children, results, type);
            });
        }

        document.getElementById('compareBtn').addEventListener('click', async () => {
            const f1 = document.getElementById('file1').files[0];
            const f2 = document.getElementById('file2').files[0];
            if (!f1 || !f2) return alert('請選擇兩個檔案');

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');

            try {
                const [d1, d2] = await Promise.all([readExcel(f1), readExcel(f2)]);
                
                // 抓取母階資訊用於命名
                const r1 = d1.find(r => parseLevel(r.Level).depth === 0) || { Part: "Unknown", Rev: "" };
                const r2 = d2.find(r => parseLevel(r.Level).depth === 0) || { Part: "Unknown", Rev: "" };
                rootInfo = { oldRoot: r1, newRoot: r2 };

                const tree1 = buildTree(d1);
                const tree2 = buildTree(d2);

                compareResults = [];
                compareNodes(tree1, tree2, compareResults);
                
                render(compareResults);
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert("比對過程發生錯誤。");
                document.getElementById('loader').classList.add('hidden');
            }
        });

        function render(data) {
            const body = document.getElementById('resultBody');
            body.innerHTML = '';
            let c = { '新增': 0, '刪除': 0, '變更': 0 };

            if (data.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="py-20 text-center text-gray-400 font-sans">未偵測到任何指定欄位的變更。</td></tr>';
                return;
            }

            data.forEach(res => {
                c[res.type]++;
                const tr = document.createElement('tr');
                tr.className = `border-b border-gray-100 hover:bg-gray-50 transition-all ${res.type==='新增'?'diff-added':res.type==='刪除'?'diff-deleted':'diff-modified'}`;
                
                let detail = "";
                if (res.type === '變更') {
                    detail = res.diffs.map(d => {
                        const isHighPriority = d.col.includes('Mfr') || d.col === 'Part';
                        return `
                            <div class="flex items-center gap-2 mb-1 p-1.5 rounded text-[11px] ${isHighPriority ? 'bg-indigo-50 border-l-2 border-indigo-500 font-bold' : 'bg-white border border-gray-100'}">
                                <span class="w-24 text-gray-500 shrink-0 font-bold uppercase tracking-tighter">${d.col}</span>
                                <span class="text-gray-400 line-through italic truncate max-w-[200px] font-sans">${d.v1 || '(空)'}</span>
                                <span class="text-indigo-600 font-bold mx-1">➔</span>
                                <span class="text-indigo-900 font-bold underline decoration-indigo-300 underline-offset-2 font-sans">${d.v2 || '(空)'}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    detail = `<span class="text-xs text-gray-400 font-medium italic font-sans">${res.type === '新增' ? '★ 新版產品導入' : '✖ 舊版產品移除'}</span>`;
                }

                const indentLevel = res.data._lv.depth;
                let indentHTML = "";
                for(let i=0; i<indentLevel; i++) {
                    indentHTML += `<div class="indent-line h-full inline-block"></div>`;
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase text-white ${res.type==='新增'?'bg-green-600':res.type==='刪除'?'bg-red-600':'bg-amber-500'} font-sans">
                            ${res.type}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            ${indentHTML}
                            <div class="flex items-center gap-2 ml-2">
                                <span class="text-[9px] bg-gray-100 px-1 py-0.5 rounded text-gray-500 font-mono">${res.data.Level}</span>
                                <span class="font-bold text-gray-800 tracking-tight font-sans">${res.data.Part}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center text-indigo-500 font-mono font-bold">${res.data.Item || ''}</td>
                    <td class="px-6 py-4 text-xs text-gray-400 font-medium font-sans">${res.data.Parent || ''}</td>
                    <td class="px-6 py-4">${detail}</td>
                `;
                body.appendChild(tr);
            });

            document.getElementById('totalItems').innerText = data.length;
            document.getElementById('countAdded').innerText = c['新增'];
            document.getElementById('countDeleted').innerText = c['刪除'];
            document.getElementById('countModified').innerText = c['變更'];
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            if (compareResults.length === 0) return;

            // 決定檔名
            let filename = "BOM比對結果.xlsx";
            const { oldRoot, newRoot } = rootInfo;
            if (oldRoot && newRoot) {
                const oldPart = String(oldRoot.Part).trim();
                const newPart = String(newRoot.Part).trim();
                
                if (oldPart === newPart) {
                    // 母階料號相同：檔名命名為 "母階料號""舊版本"進版"新版本".xlsx
                    filename = `${oldPart}${oldRoot.Rev}進版${newRoot.Rev}.xlsx`;
                } else {
                    // 舊母階料號+版本 比對 新母階料號+版本
                    filename = `${oldPart}${oldRoot.Rev}比對${newPart}${newRoot.Rev}.xlsx`;
                }
            }

            // 準備導出的資料格式
            const exportData = compareResults.map(r => {
                let diffText = r.type;
                if (r.type === '變更') {
                    diffText = r.diffs.map(d => `${d.col}: ${d.v1} -> ${d.v2}`).join(' | ');
                }
                return {
                    "狀態": r.type,
                    "Level": r.data.Level,
                    "Item": r.data.Item,
                    "Part Number": r.data.Part,
                    "Parent": r.data.Parent,
                    "變更詳情": diffText
                };
            });

            // 建立活頁簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // 設定欄位寬度
            ws['!cols'] = [
                { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 25 }, { wch: 25 }, { wch: 80 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, "比對結果");
            
            // 下載檔案
            XLSX.writeFile(wb, filename);
        });
    </script>
</body>
</html>
