<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM è©¢åƒ¹åˆ†é¡è½‰å¡«å·¥å…· v4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { background-color: #2563eb !important; color: white !important; font-weight: bold; }
        .bg-blue-soft { background-color: #f0f7ff; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- æ¨™é¡Œ -->
        <div class="bg-white p-6 rounded-xl shadow-sm border-l-8 border-blue-600 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Excel è©¢åƒ¹è³‡è¨Šè½‰å¡«åˆ†é¡ç³»çµ±</h1>
                <p class="text-sm text-gray-500 mt-1">v4.2 | æ”¯æ´ STUD é—œéµå­—åˆ†é¡ã€å‹•æ…‹å¹´å¥—æ•¸è§£æã€ä¸€éµå»é …æ¬¡è¤‡è£½</p>
            </div>
            <div class="text-right text-xs text-gray-400">
                v4.2.0 | 2026-02-05
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- å·¦å´ï¼šå¿«é€Ÿè²¼ä¸Šèˆ‡å·¥ç¨‹å¸«ç®¡ç† -->
            <div class="lg:col-span-1 space-y-6">
                <!-- å¿«é€Ÿè²¼ä¸Š -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-blue-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        å¿«é€Ÿè²¼ä¸Šè³‡è¨Š
                    </h2>
                    <textarea id="bulkInput" rows="5" class="w-full text-xs p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è²¼ä¸Šå­—ä¸²ï¼š02-429411-00--2026-02-23--S604233...PT...Irene Kuan..."></textarea>
                    <button onclick="parseBulkString()" class="mt-2 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-medium shadow-sm">æ·±åº¦è§£æä¸¦å¡«å…¥</button>
                    <p class="text-[10px] text-gray-400 mt-2 italic text-center">è‡ªå‹•è¾¨è­˜å¹´å¥—æ•¸ã€7 ä½ç”³è«‹å–®è™ŸåŠæ¥­å‹™å§“å</p>
                </div>

                <!-- å·¥ç¨‹å¸«ç®¡ç† -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="font-bold text-green-700 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        å°ˆæ¡ˆå·¥ç¨‹å¸«ç®¡ç†
                    </h2>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newEngineer" class="flex-1 text-sm border border-gray-300 rounded p-2" placeholder="è¼¸å…¥å§“å">
                        <button onclick="addEngineer()" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">+</button>
                    </div>
                    <div id="engineerList" class="max-h-32 overflow-y-auto space-y-1 border-t pt-2"></div>
                </div>
            </div>

            <!-- å³å´ï¼šè©³ç´°è³‡è¨Šèˆ‡æª”æ¡ˆä¸Šå‚³ -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-600 uppercase">å‹è™Ÿåç¨±/å®¢æˆ¶æ–™è™Ÿ</label>
                            <input type="text" id="modelName" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border focus:bg-white transition">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">å°ˆæ¡ˆå·¥ç¨‹å¸«</label>
                            <select id="engineerSelect" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border focus:bg-white"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase"><b>éœ€æ±‚æ—¥æœŸ(è«‹è‡ªè¡Œèª¿æ•´)</b></label>
                            <input type="date" id="reqDate" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">ç”³è«‹å–®è™Ÿ</label>
                            <input type="text" id="appNo" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">å¹´å¥—æ•¸</label>
                            <input type="number" id="annualSets" value="1" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">RFQ NO.</label>
                            <input type="text" id="rfqNo" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">è² è²¬æ¥­å‹™</label>
                            <input type="text" id="sales" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase">æœ€çµ‚å®¢æˆ¶</label>
                            <input type="text" id="endCustomer" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md p-2 border">
                        </div>
                    </div>

                    <hr class="my-6 border-gray-100">

                    <!-- æª”æ¡ˆä¸Šå‚³å€ -->
                    <div class="border-2 border-dashed border-blue-200 rounded-xl p-8 bg-blue-50 text-center transition hover:border-blue-400">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-10 py-3 rounded-full hover:bg-blue-700 shadow-md transition font-bold">é¸æ“‡ BOM æª”æ¡ˆ</button>
                        <p id="fileNameDisplay" class="mt-3 text-sm text-blue-700 font-medium"></p>
                        
                        <div id="sheetSelectionArea" class="mt-4 hidden flex flex-col items-center gap-3">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold">ç›®æ¨™åˆ†é :</span>
                                <select id="sheetSelect" class="bg-white border border-gray-300 rounded-md p-1.5 text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <button onclick="processSelectedSheet()" class="bg-green-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-green-700 transition">åŸ·è¡Œè§£æèˆ‡åˆ†é¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. è§£æçµæœé¡¯ç¤ºå€ -->
        <div id="resultsArea" class="hidden bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-800 p-3 flex flex-wrap justify-between items-center gap-3">
                <div class="flex space-x-1">
                    <button onclick="switchTab('parts')" id="tab-parts" class="px-5 py-2 rounded text-white transition text-sm font-medium hover:bg-gray-700">é›¶ä»¶ (<span id="count-parts">0</span>)</button>
                    <button onclick="switchTab('mechanical')" id="tab-mechanical" class="px-5 py-2 rounded text-white transition text-sm font-medium hover:bg-gray-700">æ©Ÿæ§‹ (<span id="count-mechanical">0</span>)</button>
                    <button onclick="switchTab('packaging')" id="tab-packaging" class="px-5 py-2 rounded text-white transition text-sm font-medium hover:bg-gray-700">åŒ…è£ (<span id="count-packaging">0</span>)</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyToClipboard()" class="bg-white text-gray-800 px-5 py-2 rounded font-bold hover:bg-gray-100 shadow-sm text-sm border border-gray-300 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m-1 4h.01M9 16h.01"></path></svg>
                        è¤‡è£½æ¬„ä½è³‡è¨Š (ä¸å«é …æ¬¡)
                    </button>
                    <button onclick="exportToExcel()" class="bg-yellow-500 text-gray-900 px-5 py-2 rounded font-bold hover:bg-yellow-400 shadow-sm text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ä¸‹è¼‰ Excel
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto max-h-[500px]">
                <table class="min-w-full divide-y divide-gray-200" id="previewTable">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-[11px]"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let processedData = { parts: [], mechanical: [], packaging: [] };
        let currentTab = 'parts';
        let engineers = ["æœªæŒ‡å®š"];

        const COLUMNS_PARTS = [
            "é …æ¬¡", "ç”³è«‹æ—¥æœŸ", "å°ˆæ¡ˆå·¥ç¨‹å¸«", "è² è²¬æ¥­å‹™", "éœ€æ±‚é …ç›®", "RFQ NO.", 
            "æ¨£å–®å–®è™Ÿ", "æ¨£å–®éœ€æ±‚æ—¥", "ç”³è«‹æŒ‡å®šæ–™è™Ÿ", "CEï¼(Y/N)", 
            "é›¶ä»¶æ–™è™Ÿåˆ†é¡", "é›¶ä»¶æ–™è™Ÿ", "å“å(CABLE,COLOR)", "å» ç‰Œ", "å» ç‰Œæ–™è™Ÿ", 
            "å®¢æˆ¶å…§éƒ¨é›¶ä»¶æ–™è™Ÿ", "ç”¨é‡", "UM", "å¹´å¥—æ•¸", "å¹´ç”¨é‡", "Parts Type", 
            "åƒ¹æ ¼éœ€æ±‚", "ç„¡é¹µYæœ‰é¹µN", "Remark(Data Sheet)", "é›»æ¸¬æ¸¬è©¦è¨­å‚™", 
            "é›»æ¸¬æ¸¬è©¦æ¢ä»¶", "å‹è™Ÿåç¨±orå®¢æˆ¶æ–™è™Ÿ", "æœ€çµ‚å®¢æˆ¶"
        ];

        const COLUMNS_MECH = [
            "é …æ¬¡", "ç”³è«‹æ—¥æœŸ", "å°ˆæ¡ˆå·¥ç¨‹å¸«", "è² è²¬æ¥­å‹™", "éœ€æ±‚é …ç›®", "RFQ NO.", 
            "æ¨£å–®å–®è™Ÿ", "æ¨£å–®éœ€æ±‚æ—¥", "ç”³è«‹æŒ‡å®šæ–™è™Ÿ", "CEï¼(Y/N)", 
            "é›¶ä»¶æ–™è™Ÿåˆ†é¡", "é›¶ä»¶æ–™è™Ÿ", "å“å(CABLE,COLOR)", "å» ç‰Œ", "å» ç‰Œæ–™è™Ÿ", 
            "å®¢æˆ¶å…§éƒ¨é›¶ä»¶æ–™è™Ÿ", "ç”¨é‡", "UM", "å¹´å¥—æ•¸", "å¹´ç”¨é‡", "Parts Type", 
            "åƒ¹æ ¼éœ€æ±‚", "ç„¡é¹µYæœ‰é¹µN", "Remark(Data Sheet)", 
            "å‹è™Ÿåç¨±orå®¢æˆ¶æ–™è™Ÿ", "æœ€çµ‚å®¢æˆ¶"
        ];

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reqDate').value = today;
            loadEngineers();
        };

        function loadEngineers() {
            const saved = localStorage.getItem('bom_engineers');
            if (saved) engineers = JSON.parse(saved);
            renderEngineerList();
        }
        function saveEngineers() { localStorage.setItem('bom_engineers', JSON.stringify(engineers)); }
        function renderEngineerList() {
            const list = document.getElementById('engineerList');
            const select = document.getElementById('engineerSelect');
            list.innerHTML = ''; select.innerHTML = '';
            engineers.forEach((name, index) => {
                const opt = document.createElement('option'); opt.value = name; opt.textContent = name; select.appendChild(opt);
                const div = document.createElement('div');
                div.className = "flex justify-between items-center text-xs bg-gray-50 p-1 px-2 rounded border border-gray-100";
                div.innerHTML = `<span>${name}</span><button onclick="removeEngineer(${index})" class="text-red-400 hover:text-red-600">âœ•</button>`;
                list.appendChild(div);
            });
        }
        function addEngineer() {
            const name = document.getElementById('newEngineer').value.trim();
            if (name && !engineers.includes(name)) {
                engineers.push(name); document.getElementById('newEngineer').value = '';
                saveEngineers(); renderEngineerList();
            }
        }
        function removeEngineer(index) { engineers.splice(index, 1); saveEngineers(); renderEngineerList(); }

        // --- å¿«é€Ÿè§£æé‚è¼¯ v4.2 (ä¿®å¾©å¹´å¥—æ•¸è§£æèˆ‡ç”³è«‹å–®è™Ÿ) ---
        function parseBulkString() {
            const input = document.getElementById('bulkInput').value.trim();
            if (!input) return;
            
            const parts = input.split('--');
            
            if (parts[0]) document.getElementById('modelName').value = parts[0].trim();
            if (parts[1]) {
                const dateMatch = parts[1].match(/\d{4}-\d{2}-\d{2}/);
                if (dateMatch) document.getElementById('reqDate').value = dateMatch[0];
            }
            if (parts[2]) {
                const rem = parts[2].trim();
                const rfqMatch = rem.match(/PT\d+/);
                const rfqValue = rfqMatch ? rfqMatch[0] : "";
                if (rfqValue) document.getElementById('rfqNo').value = rfqValue;

                const sMatch = rem.match(/S\d{6}/);
                if (sMatch) {
                    document.getElementById('appNo').value = sMatch[0];
                }

                if (rfqMatch) {
                    const beforeRfq = rem.split(rfqValue)[0];
                    const allNumbersBeforePT = beforeRfq.match(/\d+/g);
                    if (allNumbersBeforePT) {
                        const lastNum = allNumbersBeforePT[allNumbersBeforePT.length - 1];
                        document.getElementById('annualSets').value = parseInt(lastNum);
                    }
                }

                if (rfqValue) {
                    const afterRfq = rem.split(rfqValue)[1];
                    if (afterRfq) {
                        const words = afterRfq.trim().split(/\s+/).filter(s => s.trim());
                        if (words.length >= 2) {
                            document.getElementById('sales').value = words[0] + " " + words[1];
                            document.getElementById('endCustomer').value = words.slice(2).join(' ') || "";
                        } else {
                            document.getElementById('sales').value = afterRfq.trim();
                        }
                    }
                }
            }
            alert("æ·±åº¦è§£æå®Œæˆï¼");
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('fileNameDisplay').textContent = "ğŸ“„ " + file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, {type: 'array'});
                const sheetSelect = document.getElementById('sheetSelect');
                sheetSelect.innerHTML = '';
                workbook.SheetNames.forEach(name => {
                    const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
                    if (name.includes('4.RPABOM')) opt.selected = true;
                    sheetSelect.appendChild(opt);
                });
                document.getElementById('sheetSelectionArea').classList.remove('hidden');
            };
            reader.readAsArrayBuffer(file);
        });

        function processSelectedSheet() {
            const sheetName = document.getElementById('sheetSelect').value;
            const worksheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            classifyAndTransform(rawData);
            switchTab('parts');
            document.getElementById('resultsArea').classList.remove('hidden');
        }

        function classifyAndTransform(data) {
            processedData = { parts: [], mechanical: [], packaging: [] };
            const meta = {
                modelName: document.getElementById('modelName').value,
                reqDate: document.getElementById('reqDate').value,
                appNo: document.getElementById('appNo').value,
                annualSets: parseFloat(document.getElementById('annualSets').value) || 1,
                rfqNo: document.getElementById('rfqNo').value,
                sales: document.getElementById('sales').value,
                endCustomer: document.getElementById('endCustomer').value,
                engineer: document.getElementById('engineerSelect').value,
                today: new Date().toLocaleDateString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\//g, '-')
            };

            data.forEach(row => {
                const sbpn = String(row['ä¿¡é‚¦æ–™è™Ÿ'] || '').trim();
                if (!sbpn) return;
                
                const component = String(row['COMPONENT'] || '').trim();
                const rawDesc = String(row['å“å'] || row['DESCRIPTION'] || '').trim();
                let brand = String(row['åŸå» å» ç‰Œ'] || '').trim();
                let brandPn = String(row['åŸå» å» ç‰Œæ–™è™Ÿ'] || '').trim();
                const snp = String(row['SNP'] || '').trim();
                const qty = parseFloat(row['QTY']) || 0;

                if (snp) {
                    brand = "æ­¤ç‚º" + snp + "ä»¶";
                    brandPn = "æ­¤ç‚º" + snp + "ä»¶";
                } else {
                    if (!brand || brand.toUpperCase() === 'NA') brand = 'N/A';
                    if (!brandPn || brandPn.toUpperCase() === 'NA') brandPn = 'N/A';
                }

                const hasValidBrand = brand !== 'N/A' && !brand.includes('æ­¤ç‚º');
                let partsPn = sbpn.endsWith('*') ? "MISC" : sbpn;
                const reqItem = partsPn === "MISC" ? "è©¢åƒ¹ & ç”³è«‹é›¶ä»¶æ–™è™Ÿ" : "è©¢åƒ¹";

                let category = 'parts';
                if (sbpn.startsWith('A0')) {
                    category = 'packaging';
                } else if (sbpn.startsWith('A1') || sbpn.startsWith('A2') || sbpn.startsWith('A3') || sbpn.startsWith('A6')) {
                    category = 'parts';
                } else if (sbpn.startsWith('A4') || sbpn.startsWith('A5')) {
                    if (hasValidBrand) {
                        const upperDesc = rawDesc.toUpperCase();
                        // ä¿®æ”¹é—œéµå­—è¦å‰‡ï¼šåŒ…å« SCR, WASHER, SCRW, WSHR, STUD çš„é …ç›®åˆ†é¡è‡³æ©Ÿæ§‹
                        const isMechKeyword = ['SCR', 'WASHER', 'SCRW', 'WSHR', 'STUD'].some(k => upperDesc.startsWith(k));
                        category = isMechKeyword ? 'mechanical' : 'parts';
                    } else {
                        category = 'mechanical';
                    }
                }

                const item = {
                    "é …æ¬¡": 0,
                    "ç”³è«‹æ—¥æœŸ": meta.today,
                    "å°ˆæ¡ˆå·¥ç¨‹å¸«": meta.engineer,
                    "è² è²¬æ¥­å‹™": meta.sales,
                    "éœ€æ±‚é …ç›®": reqItem,
                    "RFQ NO.": meta.rfqNo,
                    "æ¨£å–®å–®è™Ÿ": meta.appNo, 
                    "æ¨£å–®éœ€æ±‚æ—¥": meta.reqDate,
                    "ç”³è«‹æŒ‡å®šæ–™è™Ÿ": "Y",
                    "CEï¼(Y/N)": row['CE'] || "",
                    "é›¶ä»¶æ–™è™Ÿåˆ†é¡": sbpn,
                    "é›¶ä»¶æ–™è™Ÿ": partsPn,
                    "å“å(CABLE,COLOR)": rawDesc,
                    "å» ç‰Œ": brand,
                    "å» ç‰Œæ–™è™Ÿ": brandPn,
                    "å®¢æˆ¶å…§éƒ¨é›¶ä»¶æ–™è™Ÿ": component,
                    "ç”¨é‡": qty,
                    "UM": row['UM'] || "",
                    "å¹´å¥—æ•¸": meta.annualSets,
                    "å¹´ç”¨é‡": qty * meta.annualSets,
                    "Parts Type": "",
                    "åƒ¹æ ¼éœ€æ±‚": "æœŸè²¨éšæ¢¯å¼å ±åƒ¹",
                    "ç„¡é¹µYæœ‰é¹µN": "æœ‰é¹µN",
                    "Remark(Data Sheet)": "",
                    "é›»æ¸¬æ¸¬è©¦è¨­å‚™": "", 
                    "é›»æ¸¬æ¸¬è©¦æ¢ä»¶": "", 
                    "å‹è™Ÿåç¨±orå®¢æˆ¶æ–™è™Ÿ": meta.modelName,
                    "æœ€çµ‚å®¢æˆ¶": meta.endCustomer
                };

                processedData[category].push(item);
            });

            Object.keys(processedData).forEach(cat => {
                processedData[cat].sort((a, b) => a["é›¶ä»¶æ–™è™Ÿåˆ†é¡"].localeCompare(b["é›¶ä»¶æ–™è™Ÿåˆ†é¡"], undefined, {numeric: true}));
                processedData[cat].forEach((item, idx) => item["é …æ¬¡"] = idx + 1);
            });

            document.getElementById('count-parts').textContent = processedData.parts.length;
            document.getElementById('count-mechanical').textContent = processedData.mechanical.length;
            document.getElementById('count-packaging').textContent = processedData.packaging.length;
        }

        function switchTab(tab) {
            currentTab = tab;
            ['parts', 'mechanical', 'packaging'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.toggle('tab-active', t === tab);
            });
            renderTable();
        }

        function getColsForCurrentTab() {
            return currentTab === 'mechanical' ? COLUMNS_MECH : COLUMNS_PARTS;
        }

        function renderTable() {
            const data = processedData[currentTab];
            const headerRow = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            headerRow.innerHTML = ''; body.innerHTML = '';
            if (data.length === 0) return;

            const cols = getColsForCurrentTab();
            cols.forEach(col => {
                const th = document.createElement('th');
                th.className = "px-3 py-3 text-left font-bold border-b border-gray-200 whitespace-nowrap text-gray-600 bg-gray-50";
                th.textContent = col;
                headerRow.appendChild(th);
            });

            data.forEach(item => {
                const tr = document.createElement('tr'); tr.className = "hover:bg-blue-50 transition border-b border-gray-100";
                cols.forEach(col => {
                    const td = document.createElement('td');
                    td.className = "px-3 py-2 whitespace-nowrap border-r border-gray-50 last:border-0";
                    td.textContent = item[col] || "";
                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });
        }

        function copyToClipboard() {
            const data = processedData[currentTab];
            if (data.length === 0) return;

            const cols = getColsForCurrentTab();
            const colsToCopy = cols.filter(c => c !== "é …æ¬¡");

            let tsv = colsToCopy.join('\t') + '\n';
            data.forEach(row => {
                tsv += colsToCopy.map(col => row[col] || "").join('\t') + '\n';
            });

            const textarea = document.createElement('textarea');
            textarea.value = tsv;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert(`å·²è¤‡è£½ ${data.length} ç­†è³‡æ–™åˆ°å‰ªè²¼ç°¿ (ä¸å«é …æ¬¡)ï¼`);
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ã€‚');
            }
            document.body.removeChild(textarea);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const sheetNames = { parts: "é›¶ä»¶", mechanical: "æ©Ÿæ§‹", packaging: "åŒ…è£" };
            Object.keys(processedData).forEach(key => {
                if (processedData[key].length > 0) {
                    const cols = key === 'mechanical' ? COLUMNS_MECH : COLUMNS_PARTS;
                    const ws = XLSX.utils.json_to_sheet(processedData[key], { header: cols });
                    XLSX.utils.book_append_sheet(wb, ws, sheetNames[key]);
                }
            });
            XLSX.writeFile(wb, `è©¢åƒ¹è¼¸å‡ºå–®_${document.getElementById('appNo').value || 'BOM'}.xlsx`);
        }
    </script>
</body>
</html>
